<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ESP32 Data Fetcher</title>
    <script src="chart.min.js"></script>
    <style>
        /* Equivalent of Tailwind utility classes used in data_page.html */

        .bg-gray-100 { background-color: #f3f4f6; }
        .container { width: 100%; margin-left: auto; margin-right: auto; }
        .mx-auto { margin-left: auto; margin-right: auto; }
        .p-8 { padding: 2rem; }
        .max-w-5xl { max-width: 64rem; } /* Equivalent to 64rem */
        .space-y-8 > :not([hidden]) ~ :not([hidden]) { --tw-space-y-reverse: 0; margin-top: calc(2rem * calc(1 - var(--tw-space-y-reverse))); margin-bottom: calc(2rem * var(--tw-space-y-reverse)); }
        .text-center { text-align: center; }
        .relative { position: relative; }
        .text-4xl { font-size: 2.25rem; line-height: 2.5rem; }
        .font-bold { font-weight: 700; }
        .text-gray-500 { color: #6b7280; }
        .mt-2 { margin-top: 0.5rem; }
        .absolute { position: absolute; }
        .top-0 { top: 0; }
        .right-0 { right: 0; }
        .bg-purple-200 { background-color: #e9d5ff; }
        .hover\:bg-gray-300:hover { background-color: #d1d5db; }
        .text-gray-800 { color: #1f2937; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .bg-white { background-color: #ffffff; }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .p-6 { padding: 1.5rem; }
        .text-xl { font-size: 1.25rem; line-height: 1.75rem; }
        .font-semibold { font-weight: 600; }
        .mb-4 { margin-bottom: 1rem; }
        .w-full { width: 100%; }
        .bg-purple-500 { background-color: #8b5cf6; }
        .hover\:bg-purple-600:hover { background-color: #7c3aed; }
        .text-white { color: #ffffff; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .md\:flex-row { flex-direction: row; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .mt-4 { margin-top: 1rem; }
        .md\:mt-0 { margin-top: 0; }
        .mr-2 { margin-right: 0.5rem; }
        .text-gray-700 { color: #374151; }
        .p-2 { padding: 0.5rem; }
        .border { border-width: 1px; }
        .rounded-md { border-radius: 0.375rem; }
        .text-center { text-align: center; }
        .relative { position: relative; }
        .h-96 { height: 24rem; } /* Equivalent to 24rem */
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-8 max-w-5xl space-y-8">
        <header class="text-center relative">
            <h1 class="text-4xl font-bold">ESP32 Data Fetcher</h1>
            <p class="text-gray-500 mt-2">Connect to the ESP32's Wi-Fi to fetch data.</p>
            <div class="absolute top-0 right-0">
                 <a href="/parameters.html" class="bg-purple-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">
                    Parameters
                </a>
            </div>
        </header>

        <main class="space-y-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">Data Management</h2>
                <button id="fetchButton" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg">Fetch and Display Data</button>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Data Visualization</h2>
                    <div class="mt-4 md:mt-0">
                        <label for="channel-select" class="mr-2 text-gray-700">Select Channel:</label>
                        <select id="channel-select" class="p-2 border rounded-md bg-white">
                            <option value="" disabled selected>Loading channels...</option>
                        </select>
                    </div>
                </div>
                <p id="data-status" class="text-center text-gray-500 mb-4">Click the button to begin.</p>
                <div class="relative h-96"><canvas id="dataChart"></canvas></div>
            </div>
        </main>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const fetchButton = document.getElementById('fetchButton');
        const dataStatus = document.getElementById('data-status');
        const chartCanvas = document.getElementById('dataChart');
        const channelSelect = document.getElementById('channel-select');
        let dataChart;
        let parsedCsvData = [];

        // Global variable to store configuration fetched from ESP32
        let channelConfigData = []; 

        function initializeChart() { 
            if (dataChart) dataChart.destroy(); 
            dataChart = new Chart(chartCanvas.getContext('2d'), { 
                type: 'line', 
                data: { 
                    labels: [], 
                    datasets: [{ 
                        label: 'Sensor Data', 
                        data: [], 
                        borderColor: 'rgba(75, 192, 192, 1)', 
                        backgroundColor: 'rgba(75, 192, 192, 0.2)', 
                        fill: true, 
                        pointRadius: 1, 
                        borderWidth: 1 
                    }] 
                }, 
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time (ms) Since Boot'
                            }
                        }
                    }
                } 
            }); 
        }

        async function fetchConfig() {
            try {
                const response = await fetch('/config.json');
                if (!response.ok) throw new Error('HTTP error fetching config');
                
                channelConfigData = await response.json();
                populateChannelSelect(channelConfigData.channels);
            } catch (error) {
                console.error('Failed to fetch config:', error);
                channelSelect.innerHTML = '<option value="" disabled selected>Error loading config</option>';
                dataStatus.textContent = 'Error loading channel configuration. Check ESP32 server.';
            }
        }

        function populateChannelSelect(channels) {
            channelSelect.innerHTML = '';
            let defaultSelected = false;

            channels.forEach(ch => {
                const option = document.createElement('option');
                option.value = ch.id; // Channel ID (1, 2, 3, or 4)
                
                const status = ch.enabled ? '' : ' (Disabled)';
                option.textContent = `${ch.id}: ${ch.name}${status}`;
                
                option.disabled = !ch.enabled; // Disable selection if not enabled

                if (ch.enabled && !defaultSelected) {
                    option.selected = true;
                    defaultSelected = true;
                }
                
                channelSelect.appendChild(option);
            });

            if (!defaultSelected) {
                dataStatus.textContent = 'No channels are currently enabled for logging. Check Parameters.';
            }
        }

        fetchButton.addEventListener('click', async () => { 
            // 1. Check if config data is available first
            if (channelConfigData.length === 0) {
                 await fetchConfig();
                 if (channelConfigData.length === 0) return;
            }

            // 2. Fetch the data file
            const url = `/data.csv`; 
            dataStatus.textContent = 'Fetching data...'; 
            fetchButton.disabled = true; 
            try { 
                const response = await fetch(url); 
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); 
                const csvText = await response.text(); 
                
                // Process the CSV. Assuming columns are [Millis, Ch1_Data, Ch2_Data, Ch3_Data, Ch4_Data]
                parsedCsvData = csvText.trim().split('\n').map(row => row.split(',')); 
                updateChart(); 
            } catch (error) { 
                dataStatus.textContent = `Failed to fetch data. Error: ${error}. Ensure the ESP32 log file is ready.`; 
            } finally { 
                fetchButton.disabled = false; 
            } 
        });

        channelSelect.addEventListener('change', () => { 
            if (parsedCsvData.length > 0) { 
                updateChart(); 
            } 
        });

        function updateChart() { 
            if (parsedCsvData.length === 0) { 
                dataStatus.textContent = 'No data available. Click "Fetch" to load data.'; 
                return; 
            } 
            
            // Get the selected channel ID (1, 2, 3, or 4)
            const selectedChannelID = parseInt(channelSelect.value, 10); 
            // FIXED COLUMN MAPPING: CSV column index is (Channel ID)
            // Column 0 is Millis. Column 1 is Ch1, Column 2 is Ch2, etc.
            const selectedColumnIndex = selectedChannelID; 
            
            const selectedChannelName = channelSelect.options[channelSelect.selectedIndex].text; 

            // Column 0 is the millis() value, used for the X-axis labels
            const labels = parsedCsvData.map(row => row[0]); 
            
            // Extract data from the selected column
            const data = parsedCsvData.map(row => parseFloat(row[selectedColumnIndex]) || 0); 

            dataChart.data.labels = labels; 
            dataChart.data.datasets[0].data = data; 
            dataChart.data.datasets[0].label = selectedChannelName; 
            dataChart.update(); 
            
            dataStatus.textContent = `Displaying ${data.length} records for ${selectedChannelName}. (Using CSV Column ${selectedColumnIndex})`; 
        }

        initializeChart();
        fetchConfig(); // Load channel configuration when the page loads
    });
</script>
</body>
</html>
